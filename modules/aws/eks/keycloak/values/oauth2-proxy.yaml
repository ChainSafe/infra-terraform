fullnameOverride: oauth2-proxy
config:
  existingSecret: ${oauth2_secret}
  # https://raw.githubusercontent.com/oauth2-proxy/oauth2-proxy/master/contrib/oauth2-proxy.cfg.example
  # language=cfg
  configFile: |-
    provider = "keycloak-oidc"
    oidc_issuer_url = "${oidc_issuer_url}"
    reverse_proxy = true
    email_domains = [
     "*"
    ]
    redirect_url = "https://${oauth2_proxy_dns}/oauth2/callback"
    cookie_domains = [
      ".${domain}"
    ]
    whitelist_domains = [
      ".${domain}"
    ]
    cookie_secure = true
    cookie_samesite = "lax"
    #
    # upstreams = [ "file:///dev/null" ]

    # Forward identity info
    set_xauthrequest = true
    pass_access_token = true
    set_authorization_header = true
    pass_authorization_header = true

    ## bypass authentication for requests that match the method & path. Format: method=path_regex OR path_regex alone for all methods
    skip_auth_routes = [
        "GET=^/probe",
        "^/metrics"
    ]
    ## mark paths as API routes to get HTTP Status code 401 instead of redirect to login page
    api_routes = [
        "^/api"
    ]

ingress:
  enabled: true
  className: nginx
  annotations:
    kubernetes.io/tls-acme: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
  hosts:
    - ${oauth2_proxy_dns}

sessionStorage:
  type: redis
  redis:
    password: redis-password
htpasswdFile:
  enabled: true
  existingSecret: ${htpasswd_secret}

redis:
  enabled: true
  replicas: 1
  auth: true
  redisPassword: redis-password
  redis:
    config:
      min-replicas-to-write: 0
  persistentVolume:
    enabled: false
